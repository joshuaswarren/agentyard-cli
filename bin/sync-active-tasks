#!/usr/bin/env bash
# Sync active-tasks.txt with actual zellij sessions and worktrees
set -euo pipefail

state_dir="$HOME/agentyard/state"
mkdir -p "$state_dir"
active_tasks_file="$state_dir/active-tasks.txt"
temp_file=$(mktemp)

echo "üîÑ Syncing active tasks with zellij sessions and worktrees..."

# Get all zellij sessions matching our pattern
zellij_sessions=$(zellij list-sessions --short 2>/dev/null | grep -E '^[^-]+-[0-9]+$' || true)

# Start with empty file
> "$temp_file"

# Track statistics
found_count=0
missing_worktree_count=0

# Check each session
for session in $zellij_sessions; do
  project="${session%-*}"
  slug="${session##*-}"
  worktree_dir="$HOME/work/${project}-wt/$slug"
  
  # Only include if worktree exists
  if [[ -d "$worktree_dir/.git" ]]; then
    # Get branch name
    branch=$(git -C "$worktree_dir" rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")
    
    # Check for log file
    safe_branch=$(echo "$branch" | tr '/' '_')
    log_file="$HOME/logs/$project/${session}-${safe_branch}.log"
    
    # Add to temp file
    {
      echo "- session_name: $session"
      echo "  project: $project"
      echo "  branch: $branch"
      echo "  worktree_path: $worktree_dir"
      echo "  creation_timestamp: unknown"  # Can't recover original timestamp
      echo "  log_file_path: $log_file"
      echo ""
    } >> "$temp_file"
    ((found_count++))
  else
    echo "  ‚ö†Ô∏è  Session $session has no worktree at $worktree_dir"
    ((missing_worktree_count++))
  fi
done

# Check for orphaned worktrees (worktrees without zellij sessions)
orphaned_count=0
for project_wt in "$HOME/work"/*-wt; do
  [[ -d "$project_wt" ]] || continue
  
  project_name=$(basename "$project_wt" | sed 's/-wt$//')
  
  for worktree_dir in "$project_wt"/[0-9][0-9][0-9]; do
    [[ -d "$worktree_dir/.git" ]] || continue
    
    slug=$(basename "$worktree_dir")
    session_name="${project_name}-${slug}"
    
    # Check if zellij session exists
    if ! zellij list-sessions --short 2>/dev/null | grep -Fxq "$session_name"; then
      echo "  ‚ö†Ô∏è  Worktree $worktree_dir has no zellij session"
      ((orphaned_count++))
    fi
  done
done

# Replace active tasks file
mv "$temp_file" "$active_tasks_file"

# Report results
echo ""
echo "üìä Sync complete:"
echo "   Active tasks found: $found_count"
if [[ "$missing_worktree_count" -gt 0 ]]; then
  echo "   Sessions without worktrees: $missing_worktree_count"
fi
if [[ "$orphaned_count" -gt 0 ]]; then
  echo "   Worktrees without sessions: $orphaned_count"
fi

echo ""
echo "‚úÖ Active tasks file updated: $active_tasks_file"
